/*\
title: $:/plugins/tobibeer/preview/link.js
type: application/javascript
module-type: startup
Enhances the link widget for on-hover previews
@preserve
\*/
!function(){var w,e=require("$:/core/modules/widgets/link.js").link,t=e.prototype.render,p=e.prototype.handleClickEvent;e.prototype.render=function(){t.apply(this,arguments);function r(e){var t=$tw.popup.popupInfo(e),e=t.popupLevel;return l.getTextReference(p+e)&&l.getTextReference(p+e+"-tiddler")===n.to?null:t}function u(){var e,t=r(s);t&&(e=t.popupLevel,clearTimeout(n.previewTimeout),$tw.popup.cancel(e),l.setText(p+ ++e+"-tiddler","text",null,n.to),-1===$tw.popup.findPopup(p+e)&&setTimeout(function(){$tw.popup.triggerPopup({domNode:s,title:p+e,wiki:l}),w=0},50))}var n=this,l=this.wiki,s=this.domNodes[0],e=l.getTiddler(n.to),a="$:/plugins/tobibeer/preview/defaults/",p="$:/temp/tobibeer/preview-",d=$tw.utils.parseKeyDescriptorTB(l.getTextReference(a+"keys","").toUpperCase()),c=l.getTextReference(a+"delay").toUpperCase();null!==(c=void 0!==c?parseInt(c):null)&&isNaN(c)&&(c=0),e&&($tw.utils.addClass(s,"tc-popup-handle"),$tw.utils.addClass(s,"tc-popup-absolute"),["mouseover","mouseout"].forEach(function(i){s.addEventListener(i,function(e){var p,t,o=e||window.event;"mouseover"===i?(p=1,(t=l.getTextReference(a+"not",""))&&$tw.utils.each(t.split(" "),function(e){for(var t=s;t&&p;){if($tw.utils.hasClass(t,e))return p=0,!1;t=t.parentNode}}),(p=p&&0<=((t=l.getTextReference(a+"exclude",""))?l.filterTiddlers(t):[]).indexOf(n.to)?0:p)&&(o.keyCode||(o.keyCode=0),$tw.utils.checkKeyDescriptorTB(o,d)?w||(w=1,u()):null!==c&&(w=0,n.previewTimeout=setTimeout(u,c)))):(w=0,clearTimeout(n.previewTimeout),e.relatedTarget?.classList.contains("tc-preview-tiddler")||$tw.popup.cancel(Math.max(0,r(s).popupLevel)))})}))},e.prototype.handleClickEvent=function(){p.apply(this,arguments),clearTimeout(this.previewTimeout),$tw.popup.cancel(Math.max(0,$tw.popup.popupInfo(this.domNodes[0]).popupLevel))}}();